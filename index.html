<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spotify Now Playing – OBS Overlay</title>
  <style>
    :root {
      --card-bg: rgba(15,15,20,0.65);
      --text: #ffffff;
      --muted: rgba(255,255,255,0.8);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 20px;
    }
    html, body {
      height: 100%;
      margin: 0;
      background: transparent;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
    }
    .overlay {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 340px; /* info grows | art fixed */
      align-items: center;
      column-gap: 16px;
      padding: 20px;
      width: 100%;
      height: 100%;
      box-sizing: border-box;
    }

    .info-card {
      min-width: 0; /* allow shrinking so art never drops */
      max-width: 1100px;
      padding: 28px 28px 24px 28px;
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(60,60,80,0.85), rgba(20,20,35,0.85));
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    .soft-glow {
      position: absolute; inset: -25%; filter: blur(40px); opacity: 0.55; pointer-events: none;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.18), rgba(0,0,0,0) 60%);
    }
    .title {
      font-weight: 800; letter-spacing: 0.3px; line-height: 1.1;
      font-size: 56px; margin: 0 0 10px 0; text-shadow: 0 2px 12px rgba(0,0,0,0.35);
    }
    .subtitle { font-size: 34px; margin: 0 0 20px 0; color: var(--muted); }

    .row { display: flex; align-items: center; gap: 16px; justify-content: space-between; }
    .time { font-weight: 800; font-size: 40px; width: 140px; text-align: left; white-space: nowrap; }
    .time.right { text-align: right; }

    .bar { position: relative; height: 16px; flex: 1; border-radius: 999px; background: rgba(255,255,255,0.14); overflow: hidden; }
    .bar > .fill { position: absolute; inset: 0; width: 0%; background: rgba(255,255,255,0.92); border-radius: inherit; }

    .art-card { width: 340px; height: 340px; border-radius: 28px; overflow: hidden; box-shadow: var(--shadow); justify-self: end; }
    .art-card img { width: 100%; height: 100%; object-fit: cover; display: block; }

    .connect { 
      appearance: none; background: #1DB954; color: #000; font-weight: 800; border: none; 
      padding: 14px 18px; border-radius: 999px; cursor: pointer; box-shadow: var(--shadow);
      font-size: 18px;
    }

    /* Hide connect/status when authenticated (CSS-level) */
    body.connected .connect { display: none !important; }
    body.connected #statusMsg { display: none; }

    /* Optional: keep side-by-side on small OBS windows */
    @media (max-width: 900px) {
      .overlay { grid-template-columns: minmax(0, 1fr) 260px; }
      .art-card { width: 260px; height: 260px; justify-self: end; }
      .title { font-size: 36px; }
      .subtitle { font-size: 20px; }
      .time { font-size: 22px; width: 90px; }
      .info-card { min-width: 0; }
    }
  </style>
</head>
<body>
  <div class="overlay">
    <div class="info-card" id="infoCard">
      <div class="soft-glow" id="softGlow"></div>
      <h1 class="title" id="title">Not connected</h1>
      <p class="subtitle" id="subtitle">Click connect to show your current Spotify track</p>

      <div class="row" style="margin-top: 6px;">
        <div class="time" id="elapsed">0:00</div>
        <div class="bar" aria-label="progress">
          <div class="fill" id="fill"></div>
        </div>
        <div class="time right" id="remaining">-0:00</div>
      </div>

      <div style="margin-top: 18px">
        <button class="connect" id="connectBtn" aria-hidden="false">Connect to Spotify</button>
        <span id="statusMsg" style="margin-left: 12px; opacity: .85;"></span>
      </div>
    </div>

    <div class="art-card" id="artCard">
      <img id="art" alt="Album art" src="" />
    </div>
  </div>

<script>
/****************************
 * 1) CONFIG – EDIT THIS
 ****************************/
const CLIENT_ID = "8d3230ed8cbb41609244dc94e87b7dbd";
const REDIRECT_URI = "https://9train.github.io/spotify-obs-overlay/";
const SCOPES = ["user-read-currently-playing", "user-read-playback-state"];

/****************************
 * PKCE OAuth helpers
 ****************************/
async function sha256(plain) { const enc = new TextEncoder().encode(plain); const buf = await crypto.subtle.digest('SHA-256', enc); return new Uint8Array(buf); }
function base64url(uint8) { return btoa(String.fromCharCode(...uint8)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, ''); }
function randStr(n=64){ const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let s=''; for(let i=0;i<n;i++) s+=chars[Math.floor(Math.random()*chars.length)]; return s; }

/* --- Auth/UI helpers --- */
function hideConnect() {
  const btn = document.getElementById('connectBtn');
  const status = document.getElementById('statusMsg');
  if (btn) btn.remove();
  if (status) status.remove();
}
function setConnectedUI(connected){
  document.body.classList.toggle('conne
